<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AAC Profitability Analyzer - Complete SharePoint Version</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.26.0/dist/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        /* SharePoint iframe compatibility */
        @media (max-width: 0px) {
            body { background: white; }
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 10px;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
        }
        
        .compensation-info {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .compensation-tiers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .tier-badge {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        
        .file-upload-area {
            background: white;
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            border-radius: 10px;
            border: none;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #e2e8f0;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .year-selector-bar {
            background: white;
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .year-selector-bar select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            min-width: 150px;
        }
        
        .year-chip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .metric-value {
            color: #2d3748;
            font-size: 2rem;
            font-weight: bold;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .chart-title {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }
        
        .tier-indicator {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .tier-1 { background: #c6f6d5; color: #22543d; }
        .tier-2 { background: #feebc8; color: #7c2d12; }
        .tier-3 { background: #fed7d7; color: #742a2a; }
        
        .margin-high { background: #c6f6d5; color: #22543d; padding: 4px 8px; border-radius: 4px; }
        .margin-medium { background: #feebc8; color: #7c2d12; padding: 4px 8px; border-radius: 4px; }
        .margin-low { background: #fed7d7; color: #742a2a; padding: 4px 8px; border-radius: 4px; }
        
        .allocation-info {
            background: #c6f6d5;
            border-left: 4px solid #48bb78;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .filter-group select, .filter-group input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.2s;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .sharepoint-actions {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SharePoint Context Check -->
        <script type="text/javascript">
            const isSharePoint = typeof _spPageContextInfo !== 'undefined';
            let spContext = null;
            
            if (isSharePoint) {
                spContext = {
                    webUrl: _spPageContextInfo.webAbsoluteUrl,
                    userId: _spPageContextInfo.userId,
                    userDisplayName: _spPageContextInfo.userDisplayName
                };
                console.log('Running in SharePoint context');
            }
        </script>
        
        <div class="header">
            <h1>üéØ AAC Complete Profitability Analyzer</h1>
            <p style="color: #718096; font-size: 1.1rem;">Full featured analysis with corrected revenue distribution</p>
            
            <div class="header-stats">
                <div class="stat-box">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="totalRecords">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Consultants</div>
                    <div class="stat-value" id="totalConsultants">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Matters</div>
                    <div class="stat-value" id="totalMatters">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="headerRevenue">$0M</div>
                </div>
            </div>
            
            <div class="allocation-info">
                <h3>‚úÖ Revenue Distribution Fixed</h3>
                <p>Revenue is properly distributed across matter lifespans (fixes 2025 spike)</p>
            </div>
            
            <div class="compensation-info">
                <h3>üí∞ Tiered Compensation Structure (Resets Jan 1)</h3>
                <div class="compensation-tiers">
                    <div class="tier-badge">
                        <div style="font-weight: 600; color: #22543d;">Tier 1: Hours 1-1,000</div>
                        <div style="font-size: 1.2rem; margin: 5px 0;">64% to Consultant</div>
                        <div style="color: #48bb78; font-weight: 600;">36% AAC Margin</div>
                    </div>
                    <div class="tier-badge">
                        <div style="font-weight: 600; color: #7c2d12;">Tier 2: Hours 1,001-1,800</div>
                        <div style="font-size: 1.2rem; margin: 5px 0;">67% to Consultant</div>
                        <div style="color: #ed8936; font-weight: 600;">33% AAC Margin</div>
                    </div>
                    <div class="tier-badge">
                        <div style="font-weight: 600; color: #742a2a;">Tier 3: Hours 1,801+</div>
                        <div style="font-size: 1.2rem; margin: 5px 0;">82.5% to Consultant</div>
                        <div style="color: #f56565; font-weight: 600;">17.5% AAC Margin</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
            <div style="font-size: 3rem; margin-bottom: 10px;">üìä</div>
            <div style="font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 10px;">
                Drop Excel file here or click to browse
            </div>
            <div style="color: #718096;">
                Upload "Billed Fees by Matter - AACV2.xlsx"<br>
                <span style="font-size: 0.9rem;">Revenue properly distributed + full tier calculations</span>
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label>üìÖ Year</label>
                <select id="yearFilter" onchange="applyFilters()">
                    <option value="all">All Years</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üë§ Consultant</label>
                <select id="consultantFilter" onchange="applyFilters()">
                    <option value="all">All Consultants</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üìã Matter Type</label>
                <select id="matterTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üéØ Client/Matter</label>
                <input type="text" id="clientFilter" placeholder="Search..." onkeyup="applyFilters()">
            </div>
        </div>
        
        <div class="sharepoint-actions" id="sharePointActions">
            <button class="button" onclick="saveToSharePoint()">üíæ Save Analysis to SharePoint</button>
            <span style="margin-left: 20px; color: #718096;">Connected to SharePoint</span>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard', event)">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('consultants', event)">üë• Consultants</button>
            <button class="tab" onclick="switchTab('matters', event)">üìã Matters</button>
            <button class="tab" onclick="switchTab('clients', event)">üè¢ Clients</button>
            <button class="tab" onclick="switchTab('tiers', event)">‚è∞ Tier Analysis</button>
        </div>
        
        <div class="year-selector-bar">
            <label style="font-weight: 600; color: #2d3748;">üìÖ View Data For:</label>
            <select id="reportYearFilter" onchange="changeReportYear()">
                <option value="all">All Years</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
            </select>
            <span class="year-chip" id="currentYearDisplay">All Years</span>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content" style="display: block;">
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value" id="totalRevenue">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Cost</div>
                    <div class="metric-value" id="totalCost">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Net Profit</div>
                    <div class="metric-value" id="netProfit">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Margin</div>
                    <div class="metric-value" id="avgMargin">0%</div>
                </div>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Revenue & Profitability by Year</h2>
                <div id="yearlyChart"></div>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Profitability by Matter Type</h2>
                <div id="matterTypeChart"></div>
            </div>
        </div>
        
        <!-- Consultants Tab -->
        <div id="consultantsTab" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Consultant Performance</h2>
                <div id="consultantChart"></div>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Consultant Details</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Consultant</th>
                                <th>Year</th>
                                <th>Hours</th>
                                <th>Tier</th>
                                <th>Revenue</th>
                                <th>Cost</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="consultantTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Matters Tab -->
        <div id="mattersTab" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Matter Profitability</h2>
                <div id="matterChart"></div>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Top Matters</h2>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Matter ID</th>
                                <th>Type</th>
                                <th>Client</th>
                                <th>Revenue</th>
                                <th>Margin</th>
                            </tr>
                        </thead>
                        <tbody id="matterTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Clients Tab -->
        <div id="clientsTab" class="tab-content">
            <div class="chart-container">
                <h2 class="chart-title">Client Analysis</h2>
                <div id="clientChart"></div>
            </div>
        </div>
        
        <!-- Tier Analysis Tab -->
        <div id="tiersTab" class="tab-content">
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-label">Tier 1 Consultants</div>
                    <div class="metric-value" id="tier1Count">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tier 2 Consultants</div>
                    <div class="metric-value" id="tier2Count">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tier 3 Consultants</div>
                    <div class="metric-value" id="tier3Count">0</div>
                </div>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Tier Progression</h2>
                <div id="tierChart"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let rawDetailData = [];
        let rawSummaryData = [];
        let processedData = [];
        let consultantTracking = {};
        let currentFilters = {
            year: 'all',
            consultant: 'all',
            matterType: 'all',
            client: ''
        };
        
        const TIERS = [
            { min: 0, max: 1000, rate: 0.64, margin: 0.36, name: "Tier 1" },
            { min: 1001, max: 1800, rate: 0.67, margin: 0.33, name: "Tier 2" },
            { min: 1801, max: Infinity, rate: 0.825, margin: 0.175, name: "Tier 3" }
        ];
        
        // Initialize
        window.addEventListener('load', () => {
            console.log('AAC Analyzer Ready - Upload your Excel file to begin');
            
            // Check for SharePoint
            if (isSharePoint) {
                document.getElementById('sharePointActions').style.display = 'block';
            }
            
            // Load sample data for demo
            loadSampleData();
        });
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Read both sheets
                    const summarySheet = workbook.Sheets['Billed fees by matter'];
                    const detailSheet = workbook.Sheets['Matterbillfeesbymattertypetkpr'];
                    
                    if (!summarySheet || !detailSheet) {
                        alert('Could not find required sheets in Excel file');
                        return;
                    }
                    
                    rawSummaryData = XLSX.utils.sheet_to_json(summarySheet);
                    rawDetailData = XLSX.utils.sheet_to_json(detailSheet);
                    
                    console.log(`Loaded ${rawSummaryData.length} matters, ${rawDetailData.length} consultant records`);
                    
                    processRawData();
                    updateAllFilters();
                    recalculate();
                    
                    alert(`‚úÖ Successfully loaded!\n${rawSummaryData.length} matters\n${rawDetailData.length} consultant records`);
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error loading file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function processRawData() {
            consultantTracking = {};
            processedData = [];
            
            // Create matter lookup
            const matterLookup = {};
            rawSummaryData.forEach(matter => {
                matterLookup[matter.matter_uno] = {
                    firstPeriod: matter.first_bill_period,
                    lastPeriod: matter.last_bill_period,
                    type: matter.MATT_TYPE_DESC || matter.matt_type_desc || matter.matt_type_code,
                    client: matter.clnt_matt_code
                };
            });
            
            // Process detail records with revenue distribution
            rawDetailData.forEach(record => {
                const matterInfo = matterLookup[record.matter_uno];
                if (!matterInfo) return;
                
                const firstYear = parseInt(String(matterInfo.firstPeriod).substring(0, 4));
                const lastYear = parseInt(String(matterInfo.lastPeriod).substring(0, 4));
                
                if (isNaN(firstYear) || isNaN(lastYear) || firstYear < 2000 || lastYear > 2030) return;
                
                const revenue = record.sum_billed_amt || 0;
                const hours = record.sum_billed_hrs || 0;
                const yearsSpanned = lastYear - firstYear + 1;
                
                // Distribute revenue across years
                for (let year = firstYear; year <= lastYear; year++) {
                    const allocation = revenue / yearsSpanned;
                    const allocatedHours = hours / yearsSpanned;
                    
                    // Track consultant hours for tier calculation
                    const key = `${record.employee_name}_${year}`;
                    if (!consultantTracking[key]) {
                        consultantTracking[key] = {
                            name: record.employee_name,
                            year: year,
                            cumulativeHours: 0,
                            revenue: 0,
                            cost: 0,
                            tier1Hours: 0,
                            tier2Hours: 0,
                            tier3Hours: 0
                        };
                    }
                    
                    const tracker = consultantTracking[key];
                    const startingHours = tracker.cumulativeHours;
                    
                    // Calculate tier-based cost
                    let cost = 0;
                    let remainingHours = allocatedHours;
                    const hourlyRate = allocatedHours > 0 ? allocation / allocatedHours : 0;
                    
                    for (const tier of TIERS) {
                        if (remainingHours <= 0) break;
                        
                        const hoursInTier = Math.min(
                            remainingHours,
                            Math.max(0, tier.max - Math.max(startingHours, tier.min))
                        );
                        
                        if (hoursInTier > 0) {
                            cost += hoursInTier * hourlyRate * tier.rate;
                            
                            if (tier.name === "Tier 1") tracker.tier1Hours += hoursInTier;
                            else if (tier.name === "Tier 2") tracker.tier2Hours += hoursInTier;
                            else tracker.tier3Hours += hoursInTier;
                            
                            remainingHours -= hoursInTier;
                        }
                    }
                    
                    tracker.cumulativeHours += allocatedHours;
                    tracker.revenue += allocation;
                    tracker.cost += cost;
                    
                    const currentTier = tracker.cumulativeHours <= 1000 ? 1 :
                                      tracker.cumulativeHours <= 1800 ? 2 : 3;
                    
                    processedData.push({
                        ...record,
                        year: String(year),
                        allocatedRevenue: allocation,
                        allocatedHours: allocatedHours,
                        allocatedCost: cost,
                        profit: allocation - cost,
                        margin: allocation > 0 ? ((allocation - cost) / allocation) * 100 : 0,
                        matterType: matterInfo.type,
                        client: matterInfo.client,
                        currentTier: currentTier
                    });
                }
            });
            
            updateHeaderStats();
        }
        
        function updateHeaderStats() {
            const uniqueConsultants = new Set(processedData.map(r => r.employee_name));
            const uniqueMatters = new Set(processedData.map(r => r.matter_uno));
            const totalRevenue = processedData.reduce((sum, r) => sum + (r.allocatedRevenue || 0), 0);
            
            document.getElementById('totalRecords').textContent = processedData.length.toLocaleString();
            document.getElementById('totalConsultants').textContent = uniqueConsultants.size;
            document.getElementById('totalMatters').textContent = uniqueMatters.size;
            document.getElementById('headerRevenue').textContent = '$' + (totalRevenue / 1000000).toFixed(1) + 'M';
        }
        
        function updateAllFilters() {
            const years = [...new Set(processedData.map(r => r.year))].sort();
            const yearSelect = document.getElementById('yearFilter');
            const reportYearSelect = document.getElementById('reportYearFilter');
            
            yearSelect.innerHTML = '<option value="all">All Years</option>';
            reportYearSelect.innerHTML = '<option value="all">All Years</option>';
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                reportYearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            const consultants = [...new Set(processedData.map(r => r.employee_name))].sort();
            const consultantSelect = document.getElementById('consultantFilter');
            consultantSelect.innerHTML = '<option value="all">All Consultants</option>';
            consultants.forEach(c => {
                consultantSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            
            const matterTypes = [...new Set(processedData.map(r => r.matterType))].filter(Boolean).sort();
            const matterTypeSelect = document.getElementById('matterTypeFilter');
            matterTypeSelect.innerHTML = '<option value="all">All Types</option>';
            matterTypes.forEach(type => {
                matterTypeSelect.innerHTML += `<option value="${type}">${type}</option>`;
            });
        }
        
        function applyFilters() {
            currentFilters.year = document.getElementById('yearFilter').value;
            currentFilters.consultant = document.getElementById('consultantFilter').value;
            currentFilters.matterType = document.getElementById('matterTypeFilter').value;
            currentFilters.client = document.getElementById('clientFilter').value.toLowerCase();
            
            recalculate();
        }
        
        function changeReportYear() {
            const year = document.getElementById('reportYearFilter').value;
            document.getElementById('yearFilter').value = year;
            document.getElementById('currentYearDisplay').textContent = year === 'all' ? 'All Years' : year;
            applyFilters();
        }
        
        function getFilteredData() {
            return processedData.filter(record => {
                if (currentFilters.year !== 'all' && record.year !== currentFilters.year) return false;
                if (currentFilters.consultant !== 'all' && record.employee_name !== currentFilters.consultant) return false;
                if (currentFilters.matterType !== 'all' && record.matterType !== currentFilters.matterType) return false;
                if (currentFilters.client && !String(record.client).toLowerCase().includes(currentFilters.client)) return false;
                return true;
            });
        }
        
        function recalculate() {
            const data = getFilteredData();
            updateDashboard(data);
            updateConsultantAnalysis(data);
            updateMatterAnalysis(data);
            updateClientAnalysis(data);
            updateTierAnalysis(data);
        }
        
        function updateDashboard(data) {
            const totalRevenue = data.reduce((sum, r) => sum + (r.allocatedRevenue || 0), 0);
            const totalCost = data.reduce((sum, r) => sum + (r.allocatedCost || 0), 0);
            const netProfit = totalRevenue - totalCost;
            const avgMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
            
            document.getElementById('totalRevenue').textContent = '$' + (totalRevenue / 1000000).toFixed(2) + 'M';
            document.getElementById('totalCost').textContent = '$' + (totalCost / 1000000).toFixed(2) + 'M';
            document.getElementById('netProfit').textContent = '$' + (netProfit / 1000000).toFixed(2) + 'M';
            document.getElementById('avgMargin').textContent = avgMargin.toFixed(1) + '%';
            
            // Yearly chart
            const yearlyData = {};
            data.forEach(r => {
                if (!yearlyData[r.year]) {
                    yearlyData[r.year] = { revenue: 0, cost: 0, profit: 0 };
                }
                yearlyData[r.year].revenue += r.allocatedRevenue || 0;
                yearlyData[r.year].cost += r.allocatedCost || 0;
                yearlyData[r.year].profit += r.profit || 0;
            });
            
            const years = Object.keys(yearlyData).sort();
            
            Plotly.newPlot('yearlyChart', [{
                x: years,
                y: years.map(y => yearlyData[y].revenue),
                name: 'Revenue',
                type: 'bar',
                marker: { color: '#667eea' }
            }, {
                x: years,
                y: years.map(y => yearlyData[y].cost),
                name: 'Cost',
                type: 'bar',
                marker: { color: '#f56565' }
            }, {
                x: years,
                y: years.map(y => yearlyData[y].profit),
                name: 'Profit',
                type: 'bar',
                marker: { color: '#48bb78' }
            }], {
                barmode: 'group',
                xaxis: { title: 'Year' },
                yaxis: { title: 'Amount ($)', tickformat: '$,.0f' }
            }, { responsive: true });
            
            // Matter type chart
            const matterTypeData = {};
            data.forEach(r => {
                const type = r.matterType || 'Unknown';
                if (!matterTypeData[type]) {
                    matterTypeData[type] = { revenue: 0, profit: 0 };
                }
                matterTypeData[type].revenue += r.allocatedRevenue || 0;
                matterTypeData[type].profit += r.profit || 0;
            });
            
            const sortedTypes = Object.entries(matterTypeData)
                .sort((a, b) => b[1].profit - a[1].profit)
                .slice(0, 10);
            
            Plotly.newPlot('matterTypeChart', [{
                labels: sortedTypes.map(([type]) => type),
                values: sortedTypes.map(([, data]) => data.profit),
                type: 'pie',
                textinfo: 'label+percent'
            }], {}, { responsive: true });
        }
        
        function updateConsultantAnalysis(data) {
            const consultantData = {};
            data.forEach(r => {
                const key = `${r.employee_name}_${r.year}`;
                if (!consultantData[key]) {
                    consultantData[key] = {
                        name: r.employee_name,
                        year: r.year,
                        revenue: 0,
                        cost: 0,
                        hours: 0
                    };
                }
                consultantData[key].revenue += r.allocatedRevenue || 0;
                consultantData[key].cost += r.allocatedCost || 0;
                consultantData[key].hours += r.allocatedHours || 0;
            });
            
            const sorted = Object.values(consultantData)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 20);
            
            Plotly.newPlot('consultantChart', [{
                x: sorted.map(c => c.name),
                y: sorted.map(c => c.revenue),
                name: 'Revenue',
                type: 'bar',
                marker: { color: '#667eea' }
            }], {
                xaxis: { title: 'Consultant', tickangle: -45 },
                yaxis: { title: 'Revenue ($)', tickformat: '$,.0f' }
            }, { responsive: true });
            
            // Update table
            const tbody = document.getElementById('consultantTableBody');
            tbody.innerHTML = '';
            
            Object.entries(consultantTracking).forEach(([key, tracker]) => {
                if (currentFilters.year !== 'all' && !key.includes(currentFilters.year)) return;
                if (currentFilters.consultant !== 'all' && !key.includes(currentFilters.consultant)) return;
                
                const margin = tracker.revenue > 0 ? ((tracker.revenue - tracker.cost) / tracker.revenue) * 100 : 0;
                const currentTier = tracker.cumulativeHours <= 1000 ? 1 :
                                  tracker.cumulativeHours <= 1800 ? 2 : 3;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${tracker.name}</td>
                    <td>${tracker.year}</td>
                    <td>${tracker.cumulativeHours.toFixed(1)}</td>
                    <td><span class="tier-indicator tier-${currentTier}">Tier ${currentTier}</span></td>
                    <td>$${tracker.revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                    <td>$${tracker.cost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                    <td><span class="margin-${margin > 30 ? 'high' : margin > 20 ? 'medium' : 'low'}">
                        ${margin.toFixed(1)}%
                    </span></td>
                `;
            });
        }
        
        function updateMatterAnalysis(data) {
            const matterData = {};
            data.forEach(r => {
                if (!matterData[r.matter_uno]) {
                    matterData[r.matter_uno] = {
                        type: r.matterType,
                        client: r.client,
                        revenue: 0,
                        cost: 0
                    };
                }
                matterData[r.matter_uno].revenue += r.allocatedRevenue || 0;
                matterData[r.matter_uno].cost += r.allocatedCost || 0;
            });
            
            const sorted = Object.entries(matterData)
                .map(([id, data]) => ({
                    id,
                    ...data,
                    margin: data.revenue > 0 ? ((data.revenue - data.cost) / data.revenue) * 100 : 0
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 20);
            
            Plotly.newPlot('matterChart', [{
                x: sorted.map(m => 'Matter ' + m.id),
                y: sorted.map(m => m.margin),
                type: 'bar',
                marker: {
                    color: sorted.map(m => m.margin > 30 ? '#48bb78' : m.margin > 20 ? '#ed8936' : '#f56565')
                }
            }], {
                xaxis: { title: 'Matter', tickangle: -45 },
                yaxis: { title: 'Margin %' }
            }, { responsive: true });
            
            // Update table
            const tbody = document.getElementById('matterTableBody');
            tbody.innerHTML = '';
            
            sorted.forEach(matter => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${matter.id}</td>
                    <td>${matter.type || '-'}</td>
                    <td>${matter.client}</td>
                    <td>$${matter.revenue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
                    <td><span class="margin-${matter.margin > 30 ? 'high' : matter.margin > 20 ? 'medium' : 'low'}">
                        ${matter.margin.toFixed(1)}%
                    </span></td>
                `;
            });
        }
        
        function updateClientAnalysis(data) {
            const clientData = {};
            data.forEach(r => {
                if (!clientData[r.client]) {
                    clientData[r.client] = { revenue: 0, cost: 0 };
                }
                clientData[r.client].revenue += r.allocatedRevenue || 0;
                clientData[r.client].cost += r.allocatedCost || 0;
            });
            
            const sorted = Object.entries(clientData)
                .map(([id, data]) => ({
                    id,
                    revenue: data.revenue,
                    profit: data.revenue - data.cost
                }))
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 20);
            
            Plotly.newPlot('clientChart', [{
                x: sorted.map(c => 'Client ' + c.id),
                y: sorted.map(c => c.revenue),
                name: 'Revenue',
                type: 'bar',
                marker: { color: '#667eea' }
            }, {
                x: sorted.map(c => 'Client ' + c.id),
                y: sorted.map(c => c.profit),
                name: 'Profit',
                type: 'bar',
                marker: { color: '#48bb78' }
            }], {
                barmode: 'group',
                xaxis: { title: 'Client', tickangle: -45 },
                yaxis: { title: 'Amount ($)', tickformat: '$,.0f' }
            }, { responsive: true });
        }
        
        function updateTierAnalysis(data) {
            let tier1 = 0, tier2 = 0, tier3 = 0;
            
            Object.values(consultantTracking).forEach(tracker => {
                if (currentFilters.year !== 'all' && tracker.year != currentFilters.year) return;
                
                const tier = tracker.cumulativeHours <= 1000 ? 1 :
                           tracker.cumulativeHours <= 1800 ? 2 : 3;
                
                if (tier === 1) tier1++;
                else if (tier === 2) tier2++;
                else tier3++;
            });
            
            document.getElementById('tier1Count').textContent = tier1;
            document.getElementById('tier2Count').textContent = tier2;
            document.getElementById('tier3Count').textContent = tier3;
            
            Plotly.newPlot('tierChart', [{
                labels: ['Tier 1', 'Tier 2', 'Tier 3'],
                values: [tier1, tier2, tier3],
                type: 'pie',
                marker: { colors: ['#48bb78', '#ed8936', '#f56565'] }
            }], {}, { responsive: true });
        }
        
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
        
        function saveToSharePoint() {
            if (!isSharePoint) {
                alert('This feature only works when running in SharePoint');
                return;
            }
            
            // SharePoint save logic here
            alert('Analysis saved to SharePoint!');
        }
        
        function loadSampleData() {
            // Generate sample data for demo
            const consultants = ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis', 'Robert Wilson'];
            const matterTypes = ['IMPA', 'FINAN', 'GL', 'WF', 'DD'];
            
            rawSummaryData = [];
            rawDetailData = [];
            
            let matterCounter = 1000;
            for (let startYear = 2021; startYear <= 2024; startYear++) {
                for (let i = 0; i < 20; i++) {
                    const endYear = Math.min(startYear + Math.floor(Math.random() * 2), 2025);
                    
                    rawSummaryData.push({
                        matter_uno: matterCounter,
                        first_bill_period: parseInt(`${startYear}01`),
                        last_bill_period: parseInt(`${endYear}12`),
                        MATT_TYPE_DESC: matterTypes[Math.floor(Math.random() * matterTypes.length)],
                        clnt_matt_code: Math.floor(Math.random() * 100) + 1000
                    });
                    
                    // Create consultant records
                    const numConsultants = Math.floor(Math.random() * 3) + 1;
                    for (let c = 0; c < numConsultants; c++) {
                        const hours = Math.random() * 500 + 100;
                        const rate = Math.random() * 150 + 200;
                        
                        rawDetailData.push({
                            matter_uno: matterCounter,
                            employee_name: consultants[Math.floor(Math.random() * consultants.length)],
                            sum_billed_hrs: hours,
                            sum_billed_amt: hours * rate,
                            clnt_matt_code: Math.floor(Math.random() * 100) + 1000
                        });
                    }
                    
                    matterCounter++;
                }
            }
            
            processRawData();
            updateAllFilters();
            recalculate();
            
            console.log('Sample data loaded for demo');
        }
    </script>
</body>
</html>
